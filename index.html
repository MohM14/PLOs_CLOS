<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLO Calculator</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        #error-container {
            color: orange;
            font-size: 16px;
            margin: 12px;
            min-height: 120px;
            overflow-y: auto;
            border: 1px solid orange;
            padding: 10px;
            border-radius: 8px;
            background-color: #ff96000d;
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-container"></div>
    <script type="text/babel">
        // PASTE YOUR ENTIRE JSX CODE HERE (the function App() { ... } code)

function App() {
  const [csvData, setCsvData] = React.useState([]);
  const [selectedCourses, setSelectedCourses] = React.useState([]);
  const [cloValues, setCloValues] = React.useState({});
  const [ploResults, setPloResults] = React.useState({});
  const [historicalData, setHistoricalData] = React.useState({
    year1: { K: '', S: '', V: '', year: '' },
    year2: { K: '', S: '', V: '', year: '' },
    currentYear: { year: new Date().getFullYear().toString() }
  });
  const [showResults, setShowResults] = React.useState(false);
  const [showAbout, setShowAbout] = React.useState(false);
  const [targetValue, setTargetValue] = React.useState(70);
  const [showCategoryDetails, setShowCategoryDetails] = React.useState(false);
  const [importedCloData, setImportedCloData] = React.useState(null);

  // PLO categories - dynamically extracted from CSV
  const getPloCategories = () => {
    if (csvData.length === 0) return { K: [], S: [], V: [] };
    
    const headers = Object.keys(csvData[0]);
    const ploHeaders = headers.filter(header => 
      header.match(/^[KSV]\d+$/i) && header !== 'Course_Code'
    );
    
    const categories = { K: [], S: [], V: [] };
    ploHeaders.forEach(header => {
      const category = header.charAt(0).toUpperCase();
      if (categories[category]) {
        categories[category].push(header);
      }
    });
    
    // Sort each category
    Object.keys(categories).forEach(cat => {
      categories[cat].sort((a, b) => {
        const numA = parseInt(a.substring(1));
        const numB = parseInt(b.substring(1));
        return numA - numB;
      });
    });
    
    return categories;
  };

  const ploCategories = getPloCategories();



  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const rows = text.split('\n');
        const headers = rows[0].split(',');
        const data = rows.slice(1).map(row => {
          const values = row.split(',');
          const obj = {};
          headers.forEach((header, index) => {
            obj[header.trim()] = values[index]?.trim() || '';
          });
          return obj;
        }).filter(row => row.Course_Code);
        setCsvData(data);
      };
      reader.readAsText(file);
    }
  };

  const handleCloDataImport = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const rows = text.split('\n').filter(row => row.trim());
        
        // Find the header row (should contain Course, CLO, Mapping, Male (%), Female (%), All (%))
        let headerRowIndex = -1;
        let headers = [];
        
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i].split(/[,\t]/);
          if (row.some(cell => cell.toLowerCase().includes('course')) && 
              row.some(cell => cell.toLowerCase().includes('clo')) &&
              row.some(cell => cell.toLowerCase().includes('male')) &&
              row.some(cell => cell.toLowerCase().includes('female'))) {
            headerRowIndex = i;
            headers = row.map(h => h.trim());
            break;
          }
        }
        
        if (headerRowIndex === -1) {
          alert('Invalid file format. Please ensure the file contains headers: Course, CLO, Mapping, Male (%), Female (%), All (%)');
          return;
        }
        
        // Parse data rows
        const importedData = {};
        for (let i = headerRowIndex + 1; i < rows.length; i++) {
          const values = rows[i].split(/[,\t]/);
          if (values.length >= 6) {
            const courseCode = values[0]?.trim();
            const clo = values[1]?.trim();
            const mapping = values[2]?.trim();
            const maleValue = parseFloat(values[3]?.trim()) || 0;
            const femaleValue = parseFloat(values[4]?.trim()) || 0;
            const allValue = parseFloat(values[5]?.trim()) || 0;
            
            if (courseCode && clo) {
              if (!importedData[courseCode]) {
                importedData[courseCode] = {};
              }
              importedData[courseCode][clo] = {
                male: maleValue,
                female: femaleValue,
                all: allValue,
                mapping: mapping
              };
            }
          }
        }
        
        setImportedCloData(importedData);
        setCloValues(importedData);
        alert(`Successfully imported CLO data for ${Object.keys(importedData).length} courses`);
      };
      reader.readAsText(file);
    }
  };

  const handleCourseSelection = (courseCode) => {
    setSelectedCourses(prev => 
      prev.includes(courseCode) 
        ? prev.filter(c => c !== courseCode)
        : [...prev, courseCode]
    );
  };

  const handleCloValueChange = (courseCode, clo, gender, value) => {
    // Validate input: ensure value is between 0 and 100
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue < 0 || numValue > 100) {
      return; // Don't update if invalid
    }
    
    setCloValues(prev => ({
      ...prev,
      [courseCode]: {
        ...prev[courseCode],
        [clo]: {
          ...prev[courseCode]?.[clo],
          [gender]: numValue
        }
      }
    }));
  };

  // Get active CLOs for a course (those with I, P, or M)
  const getActiveCLOs = (courseCode) => {
    const course = csvData.find(c => c.Course_Code === courseCode);
    if (!course) return [];
    
    const allPlos = [...ploCategories.K, ...ploCategories.S, ...ploCategories.V];
    return allPlos.filter(plo => 
      course[plo] && 
      course[plo] !== '' && 
      course[plo] !== 'nan' && 
      ['I', 'P', 'M'].includes(course[plo].toUpperCase())
    );
  };

  const calculatePLOs = () => {
    const results = {};
    const allPlos = [...ploCategories.K, ...ploCategories.S, ...ploCategories.V];
    
    allPlos.forEach(plo => {
      results[plo] = { 
        male: 0, female: 0, all: 0, 
        maleCount: 0, femaleCount: 0, allCount: 0 
      };
    });

    selectedCourses.forEach(courseCode => {
      const course = csvData.find(c => c.Course_Code === courseCode);
      const courseValues = cloValues[courseCode];
      
      if (course && courseValues) {
        allPlos.forEach(plo => {
          if (course[plo] && course[plo] !== '' && course[plo] !== 'nan' && ['I', 'P', 'M'].includes(course[plo].toUpperCase())) {
            const cloData = courseValues[plo];
            if (cloData) {
              // Only include non-zero values in calculations
              if (cloData.male && cloData.male > 0) {
                results[plo].male += cloData.male;
                results[plo].maleCount += 1;
              }
              if (cloData.female && cloData.female > 0) {
                results[plo].female += cloData.female;
                results[plo].femaleCount += 1;
              }
              if (cloData.all && cloData.all > 0) {
                results[plo].all += cloData.all;
                results[plo].allCount += 1;
              }
            }
          }
        });
      }
    });

    // Calculate averages (excluding zero values)
    allPlos.forEach(plo => {
      results[plo].male = results[plo].maleCount > 0 ? results[plo].male / results[plo].maleCount : 0;
      results[plo].female = results[plo].femaleCount > 0 ? results[plo].female / results[plo].femaleCount : 0;
      results[plo].all = results[plo].allCount > 0 ? results[plo].all / results[plo].allCount : 0;
      
      // Keep the maximum count for display purposes
      results[plo].count = Math.max(results[plo].maleCount, results[plo].femaleCount, results[plo].allCount);
    });

    setPloResults(results);
    setShowResults(true);
  };

  const getAverageByCategory = (category) => {
    const plos = ploCategories[category];
    const totals = { male: 0, female: 0, all: 0 };
    const counts = { male: 0, female: 0, all: 0 };

    plos.forEach(plo => {
      if (ploResults[plo] && ploResults[plo].count > 0) {
        // Only include non-zero values in category averages
        if (ploResults[plo].male > 0) {
          totals.male += ploResults[plo].male;
          counts.male++;
        }
        if (ploResults[plo].female > 0) {
          totals.female += ploResults[plo].female;
          counts.female++;
        }
        if (ploResults[plo].all > 0) {
          totals.all += ploResults[plo].all;
          counts.all++;
        }
      }
    });

    return {
      male: counts.male > 0 ? totals.male / counts.male : 0,
      female: counts.female > 0 ? totals.female / counts.female : 0,
      all: counts.all > 0 ? totals.all / counts.all : 0
    };
  };

  const downloadChart = (chartId, filename) => {
    const chartElement = document.getElementById(chartId);
    if (!chartElement) return;

    // Use html2canvas to capture the chart
    import('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js').then(html2canvas => {
      html2canvas.default(chartElement, {
        backgroundColor: '#ffffff',
        scale: 2, // High resolution
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        // Create download link
        const link = document.createElement('a');
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
      }).catch(error => {
        console.error('Error generating chart image:', error);
        // Fallback: try using SVG to canvas conversion
        fallbackChartDownload(chartId, filename);
      });
    }).catch(error => {
      console.error('Error loading html2canvas:', error);
      fallbackChartDownload(chartId, filename);
    });
  };

  const fallbackChartDownload = (chartId, filename) => {
    const chartElement = document.getElementById(chartId);
    const svg = chartElement.querySelector('svg');
    if (!svg) return;

    // Create canvas and draw SVG
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const svgData = new XMLSerializer().serializeToString(svg);
    const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(svgBlob);
    
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width * 2; // High resolution
      canvas.height = img.height * 2;
      ctx.scale(2, 2);
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      
      // Download
      const link = document.createElement('a');
      link.download = `${filename}_${new Date().toISOString().split('T')[0]}.jpg`;
      link.href = canvas.toDataURL('image/jpeg', 0.9);
      link.click();
      
      URL.revokeObjectURL(url);
    };
    img.src = url;
  };

  const downloadPLOData = () => {
    const data = [];
    
    // Add header information
    data.push(['Almaarefa University - Computer Science and Information Systems Department']);
    data.push(['PLO Calculator Results']);
    data.push(['Generated on:', new Date().toLocaleDateString()]);
    data.push(['By: Mohammed Al Gabri']);
    data.push(['']); // Empty row
    
    // Add selected courses information
    data.push(['Selected Courses:']);
    selectedCourses.forEach(courseCode => {
      data.push([courseCode]);
    });
    data.push(['']); // Empty row
    
    // Add entered CLO data
    data.push(['ENTERED CLO DATA']);
    data.push(['Course', 'CLO', 'Mapping', 'Male (%)', 'Female (%)', 'All (%)']);
    
    selectedCourses.forEach(courseCode => {
      const activeCLOs = getActiveCLOs(courseCode);
      const course = csvData.find(c => c.Course_Code === courseCode);
      const courseValues = cloValues[courseCode];
      
      activeCLOs.forEach(clo => {
        const cloData = courseValues?.[clo];
        data.push([
          courseCode,
          clo,
          course[clo],
          cloData?.male?.toFixed(2) || '0.00',
          cloData?.female?.toFixed(2) || '0.00',
          cloData?.all?.toFixed(2) || '0.00'
        ]);
      });
    });
    
    data.push(['']); // Empty row
    data.push(['CALCULATED PLO RESULTS']);
    data.push(['PLO', 'Category', 'Male (%)', 'Female (%)', 'All (%)', 'Course Count']);
    
    // Add individual PLO data
    Object.entries(ploResults).forEach(([plo, values]) => {
      if (values.count > 0) {
        const category = ploCategories.K.includes(plo) ? 'Knowledge' : 
                        ploCategories.S.includes(plo) ? 'Skills' : 'Values';
        data.push([
          plo,
          category,
          values.male.toFixed(2),
          values.female.toFixed(2),
          values.all.toFixed(2),
          values.count
        ]);
      }
    });
    
    // Add category averages
    data.push(['']); // Empty row
    data.push(['CATEGORY AVERAGES']);
    data.push(['Category', 'Type', 'Male (%)', 'Female (%)', 'All (%)', 'PLO Count']);
    
    Object.entries(ploCategories).forEach(([category, plos]) => {
      const avg = getAverageByCategory(category);
      const categoryName = category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values';
      data.push([
        `${categoryName} Average`,
        categoryName,
        avg.male.toFixed(2),
        avg.female.toFixed(2),
        avg.all.toFixed(2),
        plos.filter(plo => ploResults[plo] && ploResults[plo].count > 0).length
      ]);
    });
    
    // Add performance analysis
    data.push(['']); // Empty row
    data.push(['PERFORMANCE ANALYSIS (Target: 70%)']);
    data.push(['Category', 'Male Status', 'Female Status', 'All Status']);
    
    Object.entries(ploCategories).forEach(([category, plos]) => {
      const avg = getAverageByCategory(category);
      const categoryName = category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values';
      data.push([
        categoryName,
        avg.male >= 70 ? 'Above Target' : 'Below Target',
        avg.female >= 70 ? 'Above Target' : 'Below Target',
        avg.all >= 70 ? 'Above Target' : 'Below Target'
      ]);
    });
    
    // Convert to CSV
    const csvContent = data.map(row => row.join(',')).join('\n');
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `PLO_Complete_Report_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const BarChart = ({ data, title, target = 70 }) => {
    const maxValue = Math.max(...Object.values(data).map(d => Math.max(d.male, d.female, d.all)), target);
    
    return (
      <div className="bg-white p-4 rounded-lg shadow mb-6">
        <h3 className="text-lg font-semibold mb-4">{title}</h3>
        <div className="space-y-4">
          {Object.entries(data).map(([plo, values]) => (
            <div key={plo} className="space-y-2">
              <div className="font-medium">{plo}</div>
              <div className="flex items-center space-x-2">
                <div className="w-12 text-sm">Male:</div>
                <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                  <div 
                    className="bg-blue-500 h-6 rounded-full flex items-center justify-end pr-2"
                    style={{ width: `${(values.male / maxValue) * 100}%` }}
                  >
                    <span className="text-white text-xs">{values.male.toFixed(1)}%</span>
                  </div>
                  <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                    <div 
                      className="border-l-2 border-red-500 h-6"
                      style={{ marginLeft: `${(70 / maxValue) * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                <div className="w-12 text-sm">Female:</div>
                <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                  <div 
                    className="bg-pink-500 h-6 rounded-full flex items-center justify-end pr-2"
                    style={{ width: `${(values.female / maxValue) * 100}%` }}
                  >
                    <span className="text-white text-xs">{values.female.toFixed(1)}%</span>
                  </div>
                  <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                    <div 
                      className="border-l-2 border-red-500 h-6"
                      style={{ marginLeft: `${(70 / maxValue) * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                <div className="w-12 text-sm">All:</div>
                <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                  <div 
                    className="bg-green-500 h-6 rounded-full flex items-center justify-end pr-2"
                    style={{ width: `${(values.all / maxValue) * 100}%` }}
                  >
                    <span className="text-white text-xs">{values.all.toFixed(1)}%</span>
                  </div>
                  <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                    <div 
                      className="border-l-2 border-red-500 h-6"
                      style={{ marginLeft: `${(70 / maxValue) * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
        <div className="mt-4 text-sm text-gray-600">
          <span className="inline-block w-4 h-0.5 bg-red-500 mr-2"></span>
          Target Level: {target}%
        </div>
      </div>
    );
  };

  const VerticalBarChart = ({ data, title, target = 70 }) => {
    const plos = Object.keys(data);
    const maxValue = Math.max(...Object.values(data).map(d => Math.max(d.male, d.female, d.all)), 70, 100);
    const chartHeight = 300;
    const chartWidth = Math.max(plos.length * 80, 400);
    const barWidth = 20;
    const groupWidth = 70;
    const chartId = `vertical-chart-${title.replace(/\s+/g, '-').toLowerCase()}`;
    
    return (
      <div className="bg-white p-4 rounded-lg shadow mb-6" id={chartId}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold">{title}</h3>
          <button
            onClick={() => downloadChart(chartId, title.replace(/\s+/g, '_'))}
            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors"
          >
            📥 Download JPG
          </button>
        </div>
        <div className="overflow-x-auto">
          <svg width={chartWidth} height={chartHeight + 60} className="mx-auto">
            {/* Y-axis grid lines and labels */}
            {[0, 20, 40, 60, 80, 100].map(value => {
              const y = chartHeight - (value / maxValue) * chartHeight + 20;
              return (
                <g key={value}>
                  <line
                    x1={40}
                    y1={y}
                    x2={chartWidth - 20}
                    y2={y}
                    stroke="#e5e7eb"
                    strokeWidth="1"
                  />
                  <text
                    x={35}
                    y={y + 4}
                    textAnchor="end"
                    className="text-xs fill-gray-600"
                  >
                    {value}%
                  </text>
                </g>
              );
            })}
            
            {/* Target line */}
            <line
              x1={40}
              y1={chartHeight - (target / maxValue) * chartHeight + 20}
              x2={chartWidth - 20}
              y2={chartHeight - (target / maxValue) * chartHeight + 20}
              stroke="#ef4444"
              strokeWidth="2"
              strokeDasharray="5,5"
            />
            
            {/* Bars */}
            {plos.map((plo, index) => {
              const x = 50 + index * groupWidth;
              const values = data[plo];
              
              return (
                <g key={plo}>
                  {/* Male bar */}
                  <rect
                    x={x}
                    y={chartHeight - (values.male / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.male / maxValue) * chartHeight}
                    fill="#3b82f6"
                  />
                  <text
                    x={x + barWidth/2}
                    y={chartHeight - (values.male / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.male.toFixed(0)}
                  </text>
                  
                  {/* Female bar */}
                  <rect
                    x={x + barWidth + 2}
                    y={chartHeight - (values.female / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.female / maxValue) * chartHeight}
                    fill="#ec4899"
                  />
                  <text
                    x={x + barWidth + 2 + barWidth/2}
                    y={chartHeight - (values.female / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.female.toFixed(0)}
                  </text>
                  
                  {/* All bar */}
                  <rect
                    x={x + (barWidth + 2) * 2}
                    y={chartHeight - (values.all / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.all / maxValue) * chartHeight}
                    fill="#10b981"
                  />
                  <text
                    x={x + (barWidth + 2) * 2 + barWidth/2}
                    y={chartHeight - (values.all / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.all.toFixed(0)}
                  </text>
                  
                  {/* PLO label */}
                  <text
                    x={x + groupWidth/2}
                    y={chartHeight + 40}
                    textAnchor="middle"
                    className="text-sm font-medium"
                  >
                    {plo}
                  </text>
                </g>
              );
            })}
            
            {/* Y-axis label */}
            <text
              x={15}
              y={chartHeight/2}
              textAnchor="middle"
              className="text-sm font-medium"
              transform={`rotate(-90, 15, ${chartHeight/2})`}
            >
              Percentage (%)
            </text>
          </svg>
        </div>
        
        <div className="flex justify-center space-x-4 mt-4 text-sm">
          <div className="flex items-center">
            <div className="w-4 h-4 bg-blue-500 mr-2"></div>
            Male
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-pink-500 mr-2"></div>
            Female
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-green-500 mr-2"></div>
            All
          </div>
          <div className="flex items-center">
            <div className="w-4 h-0.5 bg-red-500 mr-2"></div>
            Target ({target}%)
          </div>
        </div>
      </div>
    );
  };

  const RadarChart = ({ data, title }) => {
    const plos = Object.keys(data);
    const center = 150;
    const radius = 100;
    const angleStep = (2 * Math.PI) / plos.length;

    const getPoint = (value, index) => {
      const angle = index * angleStep - Math.PI / 2;
      const r = (value / 100) * radius;
      return {
        x: center + r * Math.cos(angle),
        y: center + r * Math.sin(angle)
      };
    };

    const getGridPoint = (value, index) => {
      const angle = index * angleStep - Math.PI / 2;
      const r = (value / 100) * radius;
      return {
        x: center + r * Math.cos(angle),
        y: center + r * Math.sin(angle)
      };
    };

    return (
      <div className="bg-white p-4 rounded-lg shadow mb-6">
        <h3 className="text-lg font-semibold mb-4">{title}</h3>
        <svg width="300" height="300" className="mx-auto">
          {/* Grid circles */}
          {[20, 40, 60, 80, 100].map(value => (
            <circle
              key={value}
              cx={center}
              cy={center}
              r={(value / 100) * radius}
              fill="none"
              stroke="#e5e7eb"
              strokeWidth="1"
            />
          ))}
          
          {/* Grid lines */}
          {plos.map((_, index) => {
            const point = getGridPoint(100, index);
            return (
              <line
                key={index}
                x1={center}
                y1={center}
                x2={point.x}
                y2={point.y}
                stroke="#e5e7eb"
                strokeWidth="1"
              />
            );
          })}

          {/* Target line (70%) */}
          <circle
            cx={center}
            cy={center}
            r={(70 / 100) * radius}
            fill="none"
            stroke="#ef4444"
            strokeWidth="2"
            strokeDasharray="5,5"
          />

          {/* Data polygons */}
          {['male', 'female', 'all'].map((gender, gIndex) => {
            const points = plos.map((plo, index) => {
              const point = getPoint(data[plo][gender], index);
              return `${point.x},${point.y}`;
            }).join(' ');

            const colors = ['#3b82f6', '#ec4899', '#10b981'];
            
            return (
              <polygon
                key={gender}
                points={points}
                fill={colors[gIndex]}
                fillOpacity="0.2"
                stroke={colors[gIndex]}
                strokeWidth="2"
              />
            );
          })}

          {/* Labels */}
          {plos.map((plo, index) => {
            const labelPoint = getGridPoint(110, index);
            return (
              <text
                key={plo}
                x={labelPoint.x}
                y={labelPoint.y}
                textAnchor="middle"
                dominantBaseline="middle"
                className="text-sm font-medium"
              >
                {plo}
              </text>
            );
          })}
        </svg>
        <div className="flex justify-center space-x-4 mt-4 text-sm">
          <div className="flex items-center">
            <div className="w-4 h-4 bg-blue-500 mr-2"></div>
            Male
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-pink-500 mr-2"></div>
            Female
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-green-500 mr-2"></div>
            All
          </div>
        </div>
      </div>
    );
  };

  const PLOEffectivenessChart = ({ title }) => {
    // Calculate effectiveness levels for each PLO
    const effectivenessData = {};
    const allPlos = [...ploCategories.K, ...ploCategories.S, ...ploCategories.V];
    
    allPlos.forEach(plo => {
      effectivenessData[plo] = { I: 0, P: 0, M: 0 };
    });

    selectedCourses.forEach(courseCode => {
      const course = csvData.find(c => c.Course_Code === courseCode);
      if (course) {
        allPlos.forEach(plo => {
          const level = course[plo];
          if (level && ['I', 'P', 'M'].includes(level.toUpperCase())) {
            effectivenessData[plo][level.toUpperCase()]++;
          }
        });
      }
    });

    // Filter out PLOs with no data
    const activePLOs = Object.keys(effectivenessData).filter(plo => 
      effectivenessData[plo].I > 0 || effectivenessData[plo].P > 0 || effectivenessData[plo].M > 0
    );

    if (activePLOs.length === 0) return null;

    const chartHeight = 300;
    const chartWidth = Math.max(activePLOs.length * 100, 500);
    const barWidth = 25;
    const groupWidth = 90;
    const maxValue = Math.max(...activePLOs.map(plo => 
      Math.max(effectivenessData[plo].I, effectivenessData[plo].P, effectivenessData[plo].M)
    ), 1);

    return (
      <div className="bg-white p-4 rounded-lg shadow mb-6">
        <h3 className="text-lg font-semibold mb-4">{title}</h3>
        <div className="overflow-x-auto">
          <svg width={chartWidth} height={chartHeight + 60} className="mx-auto">
            {/* Y-axis grid lines and labels */}
            {Array.from({length: maxValue + 1}, (_, i) => i).map(value => {
              const y = chartHeight - (value / maxValue) * chartHeight + 20;
              return (
                <g key={value}>
                  <line
                    x1={40}
                    y1={y}
                    x2={chartWidth - 20}
                    y2={y}
                    stroke="#e5e7eb"
                    strokeWidth="1"
                  />
                  <text
                    x={35}
                    y={y + 4}
                    textAnchor="end"
                    className="text-xs fill-gray-600"
                  >
                    {value}
                  </text>
                </g>
              );
            })}
            
            {/* Bars */}
            {activePLOs.map((plo, index) => {
              const x = 50 + index * groupWidth;
              const values = effectivenessData[plo];
              
              return (
                <g key={plo}>
                  {/* I bar */}
                  <rect
                    x={x}
                    y={chartHeight - (values.I / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.I / maxValue) * chartHeight}
                    fill="#3b82f6"
                  />
                  <text
                    x={x + barWidth/2}
                    y={chartHeight - (values.I / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.I}
                  </text>
                  
                  {/* P bar */}
                  <rect
                    x={x + barWidth + 2}
                    y={chartHeight - (values.P / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.P / maxValue) * chartHeight}
                    fill="#10b981"
                  />
                  <text
                    x={x + barWidth + 2 + barWidth/2}
                    y={chartHeight - (values.P / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.P}
                  </text>
                  
                  {/* M bar */}
                  <rect
                    x={x + (barWidth + 2) * 2}
                    y={chartHeight - (values.M / maxValue) * chartHeight + 20}
                    width={barWidth}
                    height={(values.M / maxValue) * chartHeight}
                    fill="#8b5cf6"
                  />
                  <text
                    x={x + (barWidth + 2) * 2 + barWidth/2}
                    y={chartHeight - (values.M / maxValue) * chartHeight + 15}
                    textAnchor="middle"
                    className="text-xs fill-white font-medium"
                  >
                    {values.M}
                  </text>
                  
                  {/* PLO label */}
                  <text
                    x={x + groupWidth/2}
                    y={chartHeight + 40}
                    textAnchor="middle"
                    className="text-sm font-medium"
                  >
                    {plo}
                  </text>
                </g>
              );
            })}
            
            {/* Y-axis label */}
            <text
              x={15}
              y={chartHeight/2}
              textAnchor="middle"
              className="text-sm font-medium"
              transform={`rotate(-90, 15, ${chartHeight/2})`}
            >
              Number of Courses
            </text>
          </svg>
        </div>
        
        <div className="flex justify-center space-x-4 mt-4 text-sm">
          <div className="flex items-center">
            <div className="w-4 h-4 bg-blue-500 mr-2"></div>
            Introduced (I)
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-green-500 mr-2"></div>
            Practiced (P)
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-purple-500 mr-2"></div>
            Mastered (M)
          </div>
        </div>
        
        <div className="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
          <p className="text-sm text-gray-700">
            <strong>Analysis:</strong> This chart shows how many courses contribute to each PLO at different mastery levels. 
            A balanced distribution across I, P, and M levels indicates a well-structured curriculum progression.
          </p>
        </div>
      </div>
    );
  };

  const PLOValueDistributionChart = ({ title }) => {
    // Calculate how each PLO's value is composed from I, M, and P courses
    const distributionData = {};
    const allPlos = [...ploCategories.K, ...ploCategories.S, ...ploCategories.V];
    
    allPlos.forEach(plo => {
      if (ploResults[plo] && ploResults[plo].count > 0) {
        const totalValue = ploResults[plo].all; // Total PLO value
        let iContribution = 0, mContribution = 0, pContribution = 0;
        let iCount = 0, mCount = 0, pCount = 0;
        
        // Calculate contributions from each mastery level (excluding zero values)
        selectedCourses.forEach(courseCode => {
          const course = csvData.find(c => c.Course_Code === courseCode);
          const courseValues = cloValues[courseCode];
          
          if (course && courseValues && course[plo] && courseValues[plo]) {
            const level = course[plo].toUpperCase();
            const value = courseValues[plo].all || 0;
            
            // Only include non-zero values
            if (value > 0) {
              if (level === 'I') {
                iContribution += value;
                iCount++;
              } else if (level === 'M') {
                mContribution += value;
                mCount++;
              } else if (level === 'P') {
                pContribution += value;
                pCount++;
              }
            }
          }
        });
        
        // Calculate average contributions
        const iAvg = iCount > 0 ? iContribution / iCount : 0;
        const mAvg = mCount > 0 ? mContribution / mCount : 0;
        const pAvg = pCount > 0 ? pContribution / pCount : 0;
        
        // Calculate percentages of total contribution
        const totalContribution = iAvg + mAvg + pAvg;
        if (totalContribution > 0) {
          distributionData[plo] = {
            I: (iAvg / totalContribution) * 100,
            M: (mAvg / totalContribution) * 100,
            P: (pAvg / totalContribution) * 100,
            actualValue: totalValue,
            iValue: iAvg,
            mValue: mAvg,
            pValue: pAvg,
            iCount,
            mCount,
            pCount
          };
        }
      }
    });

    // Filter out PLOs with no data
    const activePLOs = Object.keys(distributionData);

    if (activePLOs.length === 0) return null;

    const chartHeight = 300;
    const chartWidth = Math.max(activePLOs.length * 120, 600);
    const barWidth = 80;
    const groupWidth = 110;

    return (
      <div className="bg-white p-4 rounded-lg shadow mb-6" id="plo-value-distribution-chart">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold">{title}</h3>
          <button
            onClick={() => downloadChart('plo-value-distribution-chart', 'PLO_Value_Distribution_Chart')}
            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors"
          >
            📥 Download JPG
          </button>
        </div>
        <div className="overflow-x-auto">
          <svg width={chartWidth} height={chartHeight + 60} className="mx-auto">
            {/* Y-axis grid lines and labels */}
            {[0, 20, 40, 60, 80, 100].map(value => {
              const y = chartHeight - (value / 100) * chartHeight + 20;
              return (
                <g key={value}>
                  <line
                    x1={40}
                    y1={y}
                    x2={chartWidth - 20}
                    y2={y}
                    stroke="#e5e7eb"
                    strokeWidth="1"
                  />
                  <text
                    x={35}
                    y={y + 4}
                    textAnchor="end"
                    className="text-xs fill-gray-600"
                  >
                    {value}%
                  </text>
                </g>
              );
            })}
            
            {/* Stacked bars showing contribution breakdown */}
            {activePLOs.map((plo, index) => {
              const x = 50 + index * groupWidth;
              const data = distributionData[plo];
              
              // Calculate heights for stacked bars
              const iHeight = (data.I / 100) * chartHeight;
              const mHeight = (data.M / 100) * chartHeight;
              const pHeight = (data.P / 100) * chartHeight;
              
              return (
                <g key={plo}>
                  {/* I contribution (bottom) */}
                  <rect
                    x={x}
                    y={chartHeight - iHeight + 20}
                    width={barWidth}
                    height={iHeight}
                    fill="#3b82f6"
                  />
                  {data.I > 5 && (
                    <text
                      x={x + barWidth/2}
                      y={chartHeight - iHeight/2 + 20}
                      textAnchor="middle"
                      className="text-xs fill-white font-medium"
                    >
                      {data.I.toFixed(0)}%
                    </text>
                  )}
                  
                  {/* M contribution (middle) */}
                  <rect
                    x={x}
                    y={chartHeight - iHeight - mHeight + 20}
                    width={barWidth}
                    height={mHeight}
                    fill="#f59e0b"
                  />
                  {data.M > 5 && (
                    <text
                      x={x + barWidth/2}
                      y={chartHeight - iHeight - mHeight/2 + 20}
                      textAnchor="middle"
                      className="text-xs fill-white font-medium"
                    >
                      {data.M.toFixed(0)}%
                    </text>
                  )}
                  
                  {/* P contribution (top) */}
                  <rect
                    x={x}
                    y={chartHeight - iHeight - mHeight - pHeight + 20}
                    width={barWidth}
                    height={pHeight}
                    fill="#10b981"
                  />
                  {data.P > 5 && (
                    <text
                      x={x + barWidth/2}
                      y={chartHeight - iHeight - mHeight - pHeight/2 + 20}
                      textAnchor="middle"
                      className="text-xs fill-white font-medium"
                    >
                      {data.P.toFixed(0)}%
                    </text>
                  )}
                  
                  {/* Total PLO value label */}
                  <text
                    x={x + barWidth/2}
                    y={10}
                    textAnchor="middle"
                    className="text-xs font-bold fill-gray-800"
                  >
                    {data.actualValue.toFixed(1)}%
                  </text>
                  
                  {/* PLO label */}
                  <text
                    x={x + barWidth/2}
                    y={chartHeight + 40}
                    textAnchor="middle"
                    className="text-sm font-medium"
                  >
                    {plo}
                  </text>
                </g>
              );
            })}
            
            {/* Y-axis label */}
            <text
              x={15}
              y={chartHeight/2}
              textAnchor="middle"
              className="text-sm font-medium"
              transform={`rotate(-90, 15, ${chartHeight/2})`}
            >
              Contribution Percentage (%)
            </text>
          </svg>
        </div>
        
        <div className="flex justify-center space-x-4 mt-4 text-sm">
          <div className="flex items-center">
            <div className="w-4 h-4 bg-blue-500 mr-2"></div>
            Introduced (I) Courses
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-yellow-500 mr-2"></div>
            Moderate (M) Courses
          </div>
          <div className="flex items-center">
            <div className="w-4 h-4 bg-green-500 mr-2"></div>
            Proficient (P) Courses
          </div>
        </div>
        
        {/* Detailed breakdown table */}
        <div className="mt-6 overflow-x-auto">
          <table className="w-full border-collapse border border-gray-300 text-sm">
            <thead>
              <tr className="bg-gray-50">
                <th className="border border-gray-300 p-2">PLO</th>
                <th className="border border-gray-300 p-2">Total Value</th>
                <th className="border border-gray-300 p-2">I Contribution</th>
                <th className="border border-gray-300 p-2">M Contribution</th>
                <th className="border border-gray-300 p-2">P Contribution</th>
                <th className="border border-gray-300 p-2">Course Count (I/M/P)</th>
              </tr>
            </thead>
            <tbody>
              {activePLOs.map(plo => {
                const data = distributionData[plo];
                return (
                  <tr key={plo}>
                    <td className="border border-gray-300 p-2 font-medium">{plo}</td>
                    <td className="border border-gray-300 p-2 text-center font-medium">{data.actualValue.toFixed(1)}%</td>
                    <td className="border border-gray-300 p-2 text-center">
                      {data.I.toFixed(1)}% ({data.iValue.toFixed(1)}%)
                    </td>
                    <td className="border border-gray-300 p-2 text-center">
                      {data.M.toFixed(1)}% ({data.mValue.toFixed(1)}%)
                    </td>
                    <td className="border border-gray-300 p-2 text-center">
                      {data.P.toFixed(1)}% ({data.pValue.toFixed(1)}%)
                    </td>
                    <td className="border border-gray-300 p-2 text-center">
                      {data.iCount}/{data.mCount}/{data.pCount}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        
        <div className="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
          <p className="text-sm text-gray-700">
            <strong>Analysis:</strong> This chart shows how each PLO's total value is composed from contributions of courses at different mastery levels (I, M, P). 
            The stacked bars show the percentage contribution from each level, helping identify where students are performing well or need improvement.
            Values in parentheses show the actual average scores from each mastery level.
          </p>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-6">
      <div className="max-w-6xl mx-auto">
        {/* University Header */}
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-2">Almaarefa University</h1>
          <h2 className="text-lg font-semibold text-gray-700 mb-4">Computer Science and Information Systems Department</h2>
        </div>
        
        <h1 className="text-3xl font-bold text-center mb-8 text-gray-800">
          Program Learning Outcomes (PLO) Calculator
        </h1>

        {/* File Upload Section */}
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-semibold mb-4">1. Upload PLO-CLO Matrix</h2>
          <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <input
              type="file"
              accept=".csv"
              onChange={handleFileUpload}
              className="hidden"
              id="csvUpload"
              required
            />
            <label htmlFor="csvUpload" className="cursor-pointer">
              <div className="text-gray-600">
                <i className="fas fa-upload text-2xl mb-2"></i>
                <p className="font-medium">Click to upload your PLO-CLO Matrix CSV file</p>
                <p className="text-sm text-gray-500">CSV file is required to proceed</p>
              </div>
            </label>
          </div>
          {csvData.length > 0 ? (
            <p className="text-green-600 mt-2">
              ✓ Matrix loaded with {csvData.length} courses
            </p>
          ) : (
            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p className="text-yellow-800 text-sm">
                <i className="fas fa-exclamation-triangle mr-2"></i>
                <strong>Required:</strong> Please upload a PLO-CLO Matrix CSV file to begin. 
                The file should contain Course_Code column and PLO columns (K1, K2, S1-S5, V1-V4) with values I, P, or M.
              </p>
            </div>
          )}
        </div>

        {/* Course Selection */}
        {csvData.length > 0 && (
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">2. Select Courses for Calculation</h2>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              {csvData.map(course => (
                <label key={course.Course_Code} className="flex items-center space-x-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={selectedCourses.includes(course.Course_Code)}
                    onChange={() => handleCourseSelection(course.Course_Code)}
                    className="rounded"
                  />
                  <span className="text-sm">{course.Course_Code}</span>
                </label>
              ))}
            </div>
          </div>
        )}

        {/* CLO Data Import Option */}
        {selectedCourses.length > 0 && (
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">3. Import CLO Data (Optional)</h2>
            <p className="text-sm text-gray-600 mb-4">
              You can import CLO data from an Excel/CSV file or enter values manually below.
            </p>
            
            <div className="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center bg-blue-50">
              <input
                type="file"
                accept=".csv,.xlsx,.xls,.txt"
                onChange={handleCloDataImport}
                className="hidden"
                id="cloDataUpload"
              />
              <label htmlFor="cloDataUpload" className="cursor-pointer">
                <div className="text-blue-600">
                  <i className="fas fa-file-excel text-2xl mb-2"></i>
                  <p className="font-medium">Click to upload CLO data file</p>
                  <p className="text-sm text-blue-500">
                    Expected format: Course | CLO | Mapping | Male (%) | Female (%) | All (%)
                  </p>
                </div>
              </label>
            </div>
            
            {importedCloData && (
              <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex justify-between items-center">
                  <p className="text-green-800 text-sm">
                    <i className="fas fa-check-circle mr-2"></i>
                    <strong>Success:</strong> CLO data imported for {Object.keys(importedCloData).length} courses. 
                    You can still modify values manually below if needed.
                  </p>
                  <button
                    onClick={() => {
                      setImportedCloData(null);
                      setCloValues({});
                    }}
                    className="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition-colors"
                  >
                    Clear Imported Data
                  </button>
                </div>
              </div>
            )}
            
            <div className="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
              <h4 className="font-medium text-gray-800 mb-2">Expected File Format:</h4>
              <div className="text-sm text-gray-600">
                <p className="mb-2">Your file should contain the following columns (separated by commas or tabs):</p>
                <div className="bg-white p-2 rounded border font-mono text-xs">
                  Course | CLO | Mapping | Male (%) | Female (%) | All (%)<br/>
                  COMP100 | K1 | I | 85.5 | 90.2 | 87.8<br/>
                  COMP100 | S1 | P | 78.0 | 82.5 | 80.2<br/>
                  ...
                </div>
              </div>
            </div>
          </div>
        )}

        {/* CLO Values Input */}
        {selectedCourses.length > 0 && (
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">4. Enter/Edit CLO Values (%)</h2>
            <p className="text-sm text-gray-600 mb-4">
              Enter values only for CLOs that are mapped to PLOs (marked with I, P, or M in the matrix). 
              {importedCloData ? 'Values from imported file are pre-filled - you can modify them as needed.' : ''}
            </p>
            
            {selectedCourses.map(courseCode => {
              const activeCLOs = getActiveCLOs(courseCode);
              const course = csvData.find(c => c.Course_Code === courseCode);
              
              if (activeCLOs.length === 0) {
                return (
                  <div key={courseCode} className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 className="font-semibold text-lg mb-2">{courseCode}</h3>
                    <p className="text-yellow-700">No CLOs are mapped to PLOs for this course.</p>
                  </div>
                );
              }
              
              return (
                <div key={courseCode} className="mb-6 p-4 border border-gray-200 rounded-lg">
                  <h3 className="font-semibold text-lg mb-4">{courseCode}</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse border border-gray-300">
                      <thead>
                        <tr className="bg-gray-50">
                          <th className="border border-gray-300 p-2">CLO</th>
                          <th className="border border-gray-300 p-2">Mapping</th>
                          <th className="border border-gray-300 p-2">Male (%)</th>
                          <th className="border border-gray-300 p-2">Female (%)</th>
                          <th className="border border-gray-300 p-2">All (%)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {activeCLOs.map(clo => (
                          <tr key={clo}>
                            <td className="border border-gray-300 p-2 font-medium">{clo}</td>
                            <td className="border border-gray-300 p-2 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                course[clo] === 'I' ? 'bg-blue-100 text-blue-800' :
                                course[clo] === 'P' ? 'bg-green-100 text-green-800' :
                                course[clo] === 'M' ? 'bg-purple-100 text-purple-800' :
                                'bg-gray-100 text-gray-800'
                              }`}>
                                {course[clo]}
                              </span>
                            </td>
                            <td className="border border-gray-300 p-2">
                              <input
                                type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                value={cloValues[courseCode]?.[clo]?.male || ''}
                                className="w-full p-1 border rounded"
                                onChange={(e) => handleCloValueChange(courseCode, clo, 'male', e.target.value)}
                              />
                            </td>
                            <td className="border border-gray-300 p-2">
                              <input
                                type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                value={cloValues[courseCode]?.[clo]?.female || ''}
                                className="w-full p-1 border rounded"
                                onChange={(e) => handleCloValueChange(courseCode, clo, 'female', e.target.value)}
                              />
                            </td>
                            <td className="border border-gray-300 p-2">
                              <input
                                type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                value={cloValues[courseCode]?.[clo]?.all || ''}
                                className="w-full p-1 border rounded"
                                onChange={(e) => handleCloValueChange(courseCode, clo, 'all', e.target.value)}
                              />
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })}
            
            <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <h4 className="font-medium text-blue-800 mb-2">Mapping Legend:</h4>
              <div className="flex space-x-4 text-sm">
                <span className="flex items-center">
                  <span className="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">I</span>
                  Introduced
                </span>
                <span className="flex items-center">
                  <span className="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 mr-2">P</span>
                  Practiced
                </span>
                <span className="flex items-center">
                  <span className="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 mr-2">M</span>
                  Mastered
                </span>
              </div>
            </div>
            
            {/* Target Performance Level Setting */}
            <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div className="flex items-center space-x-4">
                <label className="font-medium text-blue-800">Target Performance Level:</label>
                <input
                  type="number"
                  min="0"
                  max="100"
                  step="1"
                  value={targetValue}
                  onChange={(e) => setTargetValue(parseFloat(e.target.value) || 70)}
                  className="w-20 p-2 border rounded text-center"
                />
                <span className="text-blue-700">%</span>
                <span className="text-sm text-blue-600">
                  (This value will be used for performance analysis and target lines in all charts)
                </span>
              </div>
            </div>
            
            <button
              onClick={calculatePLOs}
              className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Calculate PLOs
            </button>
          </div>
        )}

        {/* Results Section */}
        {showResults && Object.keys(ploResults).length > 0 && (
          <div className="space-y-6">
            {/* Download Button and Target Setting */}
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-semibold">PLO Results</h3>
                <button
                  onClick={downloadPLOData}
                  className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
                >
                  <i className="fas fa-download"></i>
                  <span>Download PLO Data</span>
                </button>
              </div>
              

              
              <p className="text-gray-600">Download all PLO results and category averages as CSV file</p>
            </div>
            {/* Overall PLO Chart */}
            {(() => {
              const allPloData = {};
              Object.keys(ploResults).forEach(plo => {
                if (ploResults[plo] && ploResults[plo].count > 0) {
                  allPloData[plo] = ploResults[plo];
                }
              });
              
              if (Object.keys(allPloData).length === 0) return null;

              return (
                <div>
                  <VerticalBarChart 
                    data={allPloData} 
                    title="All Program Learning Outcomes (PLOs) - Vertical Bar Chart" 
                    target={targetValue}
                  />
                  <BarChart 
                    data={allPloData} 
                    title="All Program Learning Outcomes (PLOs) - Horizontal Bar Chart" 
                    target={targetValue}
                  />
                  <RadarChart 
                    data={allPloData} 
                    title="All Program Learning Outcomes (PLOs) - Radar Chart" 
                  />
                  <PLOEffectivenessChart 
                    title="PLO Mastery Levels Distribution (Course Count)" 
                  />
                  <PLOValueDistributionChart 
                    title="PLO Mastery Levels Distribution (Percentage)" 
                  />
                </div>
              );
            })()}

            {/* Category Details Toggle */}
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between">
                <h3 className="text-xl font-semibold">Category Details</h3>
                <button
                  onClick={() => setShowCategoryDetails(!showCategoryDetails)}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2"
                >
                  <i className={`fas ${showCategoryDetails ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                  <span>{showCategoryDetails ? 'Hide' : 'Show'} Category Details</span>
                </button>
              </div>
              <p className="text-gray-600 mt-2">
                {showCategoryDetails ? 'Individual charts for Knowledge, Skills, and Values categories are shown below.' : 'Click "Show Category Details" to view individual charts for each PLO category.'}
              </p>
            </div>

            {/* Individual PLO Charts */}
            {showCategoryDetails && Object.entries(ploCategories).map(([category, plos]) => {
              const categoryData = {};
              plos.forEach(plo => {
                if (ploResults[plo] && ploResults[plo].count > 0) {
                  categoryData[plo] = ploResults[plo];
                }
              });
              
              if (Object.keys(categoryData).length === 0) return null;

              return (
                <div key={category}>
                  <VerticalBarChart 
                    data={categoryData} 
                    title={`${category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values'} PLOs - Vertical Bar Chart`} 
                    target={targetValue}
                  />
                  <BarChart 
                    data={categoryData} 
                    title={`${category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values'} PLOs - Horizontal Bar Chart`} 
                    target={targetValue}
                  />
                  <RadarChart 
                    data={categoryData} 
                    title={`${category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values'} PLOs - Radar Chart`} 
                  />
                </div>
              );
            })}

            {/* Category Averages */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-semibold mb-4">PLO Category Averages</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {Object.entries(ploCategories).map(([category, plos]) => {
                  const avg = getAverageByCategory(category);
                  const categoryName = category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values';
                  
                  return (
                    <div key={category} className="text-center">
                      <h4 className="font-semibold text-lg mb-2">{categoryName} PLOs</h4>
                      <div className="space-y-2">
                        <div className="flex justify-between">
                          <span>Male:</span>
                          <span className={`font-medium ${avg.male >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                            {avg.male.toFixed(1)}%
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span>Female:</span>
                          <span className={`font-medium ${avg.female >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                            {avg.female.toFixed(1)}%
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span>All:</span>
                          <span className={`font-medium ${avg.all >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                            {avg.all.toFixed(1)}%
                          </span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* Historical Comparison */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-xl font-semibold mb-4">Historical Comparison</h3>
              
              {/* Year Input Section */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-medium mb-2">Current Year</label>
                  <div className="space-y-2">
                    <input
                      type="text"
                      placeholder="Enter Current Year"
                      value={historicalData.currentYear.year}
                      className="w-full p-2 border rounded"
                      onChange={(e) => setHistoricalData(prev => ({
                        ...prev,
                        currentYear: { ...prev.currentYear, year: e.target.value }
                      }))}
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Previous Year 1</label>
                  <div className="space-y-2">
                    <input
                      type="text"
                      placeholder="Enter Year (e.g., 2022)"
                      className="w-full p-2 border rounded"
                      onChange={(e) => setHistoricalData(prev => ({
                        ...prev,
                        year1: { ...prev.year1, year: e.target.value }
                      }))}
                    />
                    <div className="grid grid-cols-3 gap-2">
                      <input
                        type="number"
                        placeholder="K (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year1: { ...prev.year1, K: e.target.value }
                        }))}
                      />
                      <input
                        type="number"
                        placeholder="S (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year1: { ...prev.year1, S: e.target.value }
                        }))}
                      />
                      <input
                        type="number"
                        placeholder="V (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year1: { ...prev.year1, V: e.target.value }
                        }))}
                      />
                    </div>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2">Previous Year 2</label>
                  <div className="space-y-2">
                    <input
                      type="text"
                      placeholder="Enter Year (e.g., 2023)"
                      className="w-full p-2 border rounded"
                      onChange={(e) => setHistoricalData(prev => ({
                        ...prev,
                        year2: { ...prev.year2, year: e.target.value }
                      }))}
                    />
                    <div className="grid grid-cols-3 gap-2">
                      <input
                        type="number"
                        placeholder="K (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year2: { ...prev.year2, K: e.target.value }
                        }))}
                      />
                      <input
                        type="number"
                        placeholder="S (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year2: { ...prev.year2, S: e.target.value }
                        }))}
                      />
                      <input
                        type="number"
                        placeholder="V (%)"
                        className="w-full p-2 border rounded text-sm"
                        onChange={(e) => setHistoricalData(prev => ({
                          ...prev,
                          year2: { ...prev.year2, V: e.target.value }
                        }))}
                      />
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Historical Chart */}
              <div className="mt-6">
                <h4 className="font-semibold mb-4">Historical Trend Comparison</h4>
                <div className="space-y-4">
                  {['K', 'S', 'V'].map(category => {
                    const currentAvg = getAverageByCategory(category);
                    const year1Val = parseFloat(historicalData.year1[category]) || 0;
                    const year2Val = parseFloat(historicalData.year2[category]) || 0;
                    const categoryName = category === 'K' ? 'Knowledge' : category === 'S' ? 'Skills' : 'Values';
                    const year1Label = historicalData.year1.year || 'Year 1';
                    const year2Label = historicalData.year2.year || 'Year 2';
                    const currentYear = new Date().getFullYear();
                    
                    return (
                      <div key={category} className="space-y-2">
                        <div className="font-medium">{categoryName} PLOs</div>
                        <div className="flex items-center space-x-4">
                          <div className="w-20 text-sm">{year1Label}:</div>
                          <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                            <div 
                              className="bg-blue-400 h-6 rounded-full flex items-center justify-end pr-2"
                              style={{ width: `${Math.min((year1Val / 100) * 100, 100)}%` }}
                            >
                              <span className="text-white text-xs">{year1Val.toFixed(1)}%</span>
                            </div>
                            <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                              <div 
                                className="border-l-2 border-red-500 h-6"
                                style={{ marginLeft: '70%' }}
                              ></div>
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center space-x-4">
                          <div className="w-20 text-sm">{year2Label}:</div>
                          <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                            <div 
                              className="bg-blue-500 h-6 rounded-full flex items-center justify-end pr-2"
                              style={{ width: `${Math.min((year2Val / 100) * 100, 100)}%` }}
                            >
                              <span className="text-white text-xs">{year2Val.toFixed(1)}%</span>
                            </div>
                            <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                              <div 
                                className="border-l-2 border-red-500 h-6"
                                style={{ marginLeft: '70%' }}
                              ></div>
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center space-x-4">
                          <div className="w-20 text-sm">{historicalData.currentYear.year}:</div>
                          <div className="flex-1 bg-gray-200 rounded-full h-6 relative">
                            <div 
                              className="bg-blue-600 h-6 rounded-full flex items-center justify-end pr-2"
                              style={{ width: `${Math.min((currentAvg.all / 100) * 100, 100)}%` }}
                            >
                              <span className="text-white text-xs">{currentAvg.all.toFixed(1)}%</span>
                            </div>
                            <div className="absolute top-0 left-0 w-full h-6 flex items-center">
                              <div 
                                className="border-l-2 border-red-500 h-6"
                                style={{ marginLeft: '70%' }}
                              ></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-4 text-sm text-gray-600">
                  <span className="inline-block w-4 h-0.5 bg-red-500 mr-2"></span>
                  Target Level: 70%
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* About Button */}
        <div className="text-center mt-8 pt-6 border-t border-gray-300">
          <button
            onClick={() => setShowAbout(true)}
            className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm"
          >
            About
          </button>
        </div>
        
        {/* About Modal */}
        {showAbout && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg p-6 max-w-md mx-4 relative">
              <button
                onClick={() => setShowAbout(false)}
                className="absolute top-4 right-4 text-gray-500 hover:text-gray-700"
              >
                <i className="fas fa-times text-xl"></i>
              </button>
              
              <h3 className="text-xl font-bold mb-4 text-gray-800">About PLO Calculator</h3>
              
              <div className="space-y-3 text-gray-600">
                <p>
                  The Program Learning Outcomes (PLO) Calculator is a comprehensive web application designed to help academic institutions evaluate and analyze student performance against program learning outcomes.
                </p>
                
                <p>
                  <strong>Key Features:</strong>
                </p>
                <ul className="list-disc list-inside space-y-1 ml-4">
                  <li>Upload and process PLO-CLO matrix data</li>
                  <li>Calculate PLO achievements for male, female, and all students</li>
                  <li>Generate interactive visualizations (bar charts, radar charts)</li>
                  <li>Compare historical performance data</li>
                  <li>Export comprehensive reports</li>
                  <li>Target-based performance analysis (70% benchmark)</li>
                </ul>
                
                <p>
                  This system supports academic quality assurance by providing clear insights into program effectiveness and student learning outcomes across Knowledge, Skills, and Values categories.
                </p>
                
                <div className="mt-6 pt-4 border-t border-gray-200 text-center">
                  <p className="text-sm font-medium text-gray-700">
                    Developed by: <span className="text-blue-600">Mohammed Al Gabri</span>
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    Almaarefa University - Computer Science and Information Systems Department
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <script>
        window.addEventListener('error', function(event) {
            displayError(event.message, event.error?.stack);
        });
        function displayError(message, stackInfo) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.createElement('div');
            errorMessage.textContent = message;
            errorContainer.appendChild(errorMessage);
            if(stackInfo) {
                const stackErrorMessage = document.createElement('pre');
                stackErrorMessage.textContent = stackInfo.substring(0, 130);
                errorContainer.appendChild(stackErrorMessage);
            }
            errorContainer.style.display = 'block';
        }
    </script>
</body>
</html>
